<?php
	$frm = $this->frm_ilpayment;
	$tr = Application_Form_FrmLanguages::getCurrentlanguage();
	$this->headTitle($tr->translate("CUSTOMER_PAYMENT"));
	echo $this->headTitle();
	$baseurl =  Zend_Controller_Front::getInstance()->getBaseUrl();
	$base_url = Application_Form_FrmMessage::getUrl("/");
	$graiceperiod = $this->graiceperiod;
?>
<script src="<?php echo $baseurl;?>/js/help.js"></script>
   <script>
		require(["dijit/form/DateTextBox","dijit/form/NumberTextBox","dojo/number","dijit/Dialog",
		         "dijit/layout/TabContainer"]);
				 dojo.require("dijit.form.Textarea");
		dojo.require("dojo.NodeList-manipulate");
		dojo.require("dojo.html");
	    dojo.require("dojo.data.ItemFileWriteStore"); 
		dojo.require("dojo.data.ObjectStore");
   </script>
<style>	

table#table tr th.tdheader {
    background: #bcd5f0;
    border: solid 1px #a0a0a0;
    padding: 8px 4px;
}
table#table tr td input[type=checkbox] {
    margin: 0;
    padding: 0;
}
#rpt_print table{
	border-spacing: 5px !important;
    border-collapse: inherit;
}
</style>
<div class="card">
	<div class="card-content collapse show">
		<div class="card-box">
            <div class="col-sm-12 border-botom">
		    	<div class="col-sm-8 pd-0">
		    			<h4 class="m-b-0"><i class="fa fa-money" aria-hidden="true"></i>&nbsp;&nbsp;&nbsp;<?php echo $tr->translate("CUSTOMER_PAYMENT");?></h4>
    			</div>
    			<div class="col-sm-4 text-right">
    			</div>
    		</div>
    	</div>
    	<form id='frm_add_group_pay' action="<?php echo $this->url(array('module'=>'loan','controller'=>'customerpayment','action'=>'add')); ?>" dojoType="dijit.form.Form" method="post" enctype="application/x-www-form-urlencoded">
			<script type="dojo/method" event="onSubmit">
				if(this.validate()) {
					service_charge = dijit.byId('service_charge').get('value');
					receive_amount = dijit.byId('amount_receive').get('value');
					option_pay = dijit.byId('option_pay').get('value');
					total_payments = dijit.byId('total_payment').get('value');
					if(option_pay==2 || option_pay==3 || option_pay==4){
						if(receive_amount<total_payments){
							alert('You Can not pay in this option! Please Input Recieve Amount more than or equal Total Payment!');
							dijit.byId('amount_receive').focus();
							return false;
						}
					}
					if(receive_amount<0){
						alert('Please fill Recieve Amount');
						dijit.byId('amount_receive').focus();
						return false;
					}
					client = dijit.byId('client_id').get('value');
					if (client=='' || client==-1){
						alert('Please Select Client Name !');
						dijit.byId('client_id').focus();
						return false;
					}
					dijit.byId('submitButton').set('disabled',true);
           			 return true;

			}else {
				return false;
			}
			</script>
			<div class="card-box">
				<input type="hidden" dojoType="dijit.form.TextBox" name="property_id" id="property_id">
				<input type="hidden" dojoType="dijit.form.TextBox" name="sale_id" id="sale_id">
				<input type="hidden" dojoType="dijit.form.TextBox" name="datepaymentlastrecord" id="datepaymentlastrecord">
				<input type="hidden" dojoType="dijit.form.TextBox" name="lastpaiddate" id="lastpaiddate">
				<input type="hidden" dojoType="dijit.form.TextBox" name="identity" id="identity">
				<input type="hidden" dojoType="dijit.form.TextBox" name="record_id" id="record_id">
				<input type="hidden" dojoType="dijit.form.TextBox" name="curr" id="curr">
					<?php  echo $frm->getElement('reciever');?>
				<div class="col-md-4 col-sm-4 col-xs-12">
					<div class="form-group">
	                   <label class="control-label col-md-12 col-sm-12 col-xs-12 title-blog bold" ><i class="fa fa-hand-o-right" aria-hidden="true"></i> <?php echo $tr->translate("INFO_INDILOAN");?> 
	                   </label>
	                </div>
	                <div class="form-group">
	                   <label class="control-label col-md-5 col-sm-5 col-xs-12" ><?php echo $tr->translate("BRANCH_NAME");?> :
	                   </label>
	                   <div class="col-md-7 col-sm-7 col-xs-12">
	                   		<?php echo $frm->getElement("branch_id")?>
	                   </div>
	                </div>
	                <div class="form-group">
	                   <label class="control-label col-md-5 col-sm-5 col-xs-12" ><?php echo $tr->translate("CUSTOMER_NAME");?> :
	                   </label>
	                   <div class="col-md-7 col-sm-7 col-xs-12">
	                   		<input id="client_id"><input type="hidden" name="buy_with"  dojoType="dijit.form.TextBox"  id="buy_with">
	                   </div>
	                </div>
	                <div class="form-group">
	                   <label class="control-label col-md-5 col-sm-5 col-xs-12" ><?php echo $tr->translate("ADDRESS");?> :
	                   </label>
	                   <div class="col-md-7 col-sm-7 col-xs-12">
	                   		<?php echo $frm->getElement("land_address")?>
							<input type="hidden" name="sale_number"  dojoType="dijit.form.TextBox"  id="sale_number">
	                   </div>
	                </div>
	             </div>
			</div>
			<div class="card-box">
				<div class="col-md-4 col-sm-4 col-xs-12">
					<div class="form-group">
	                   <label class="control-label col-md-12 col-sm-12 col-xs-12 title-blog bold" ><i class="fa fa-hand-o-right" aria-hidden="true"></i> <?php echo $tr->translate("PAYMENT_INFORMATION");?> 
	                   </label>
	                </div>
	                <div class="form-group">
	                   <label class="control-label col-md-5 col-sm-5 col-xs-12" ><?php echo $tr->translate("RECIEPT_NO");?> :
	                   </label>
	                   <div class="col-md-7 col-sm-7 col-xs-12">
	                   		<?php echo $frm->getElement('reciept_no');?>
	                   </div>
	                </div>
	                <div class="form-group">
	                   <label class="control-label col-md-5 col-sm-5 col-xs-12" ><?php echo $tr->translate("ប្រាក់ដើមត្រូវបង់");?> :
	                   </label>
	                   <div class="col-md-7 col-sm-7 col-xs-12">
	                   		<?php echo $frm->getElement('os_amount');?>
	                   </div>
	                </div>
	                <div class="form-group">
	                   <label class="control-label col-md-5 col-sm-5 col-xs-12" ><?php echo $tr->translate("TOTAL_SERVICE_CHARGE");?> :
	                   </label>
	                   <div class="col-md-7 col-sm-7 col-xs-12">
	                   		<?php echo $frm->getElement('service_charge');echo $frm->getElement('old_service_charge');?>
	                   </div>
	                </div>
	                <div class="form-group">
	                   <label class="control-label col-md-5 col-sm-5 col-xs-12" ><?php echo $tr->translate("AMOUNT_LATE")?>
	                   <?php echo $frm->getElement('date_input');?> :
	                   </label>
	                   <div class="col-md-7 col-sm-7 col-xs-12">
	                   <?php echo $frm->getElement('late_day');?>
	                   </div>
	                </div>
	                <div class="form-group">
	                   <label class="control-label col-md-5 col-sm-5 col-xs-12" >
	                   <?php echo $tr->translate("ប្រាក់បង់ពីមុនសរុប");?> :
	                   </label>
	                   <div class="col-md-7 col-sm-7 col-xs-12">
	                   		<input dojoType="dijit.form.NumberTextBox" class="fullside" id="total_pricipalpaid" name="total_pricipalpaid" readonly  type="text">
	                   </div>
	                </div>
	            </div>
	            <div class="col-md-4 col-sm-4 col-xs-12">
					<div class="form-group">
	                   <label class="control-label col-md-12 col-sm-12 col-xs-12 title-blog bold" ><i class="fa fa-hand-o-right" aria-hidden="true"></i> <?php echo $tr->translate("PAYMENT_INFORMATION");?> 
	                   </label>
	                </div>
	                <div class="form-group">
	                   <label class="control-label col-md-5 col-sm-5 col-xs-12" >
	                   <?php echo $tr->translate("ប្រាក់ដើមនៅសល់បន្ទាប់ពីបង់");?> :
	                   </label>
	                   <div class="col-md-7 col-sm-7 col-xs-12">
	                   		<?php echo $frm->getElement('priciple_amount');?>
	                   </div>
	                </div>
	                <div class="form-group">
	                   <label class="control-label col-md-5 col-sm-5 col-xs-12" >
	                   <?php echo $tr->translate("TOTAL_INTEREST");?> :
	                   </label>
	                   <div class="col-md-7 col-sm-7 col-xs-12">
	                   		<?php echo $frm->getElement('total_interest');?>
	                   </div>
	                </div>
	                <div class="form-group">
	                   <label class="control-label col-md-5 col-sm-5 col-xs-12" >
	                   <?php echo $tr->translate("ប្រាក់បង់បន្ថែម");?> :
	                   </label>
	                   <div class="col-md-7 col-sm-7 col-xs-12">
	                   		<?php  echo $frm->getElement('extrapayment');?>
	                   </div>
	                </div>
	                <div class="form-group">
	                   <label class="control-label col-md-5 col-sm-5 col-xs-12" >
	                   <?php echo $tr->translate("TOTAL_AMOUNT_PAYMENT");?> :
	                   </label>
	                   <div class="col-md-7 col-sm-7 col-xs-12">
	                   		<?php echo $frm->getElement('total_payment');?>
                            <input type="hidden" dojotype="dijit.form.TextBox" name="oldTotalPay" id="oldTotalPay" />
	                   </div>
	                </div>
	                <div class="form-group">
	                   <label class="control-label col-md-5 col-sm-5 col-xs-12" >
	                   <?php echo $tr->translate("REMAIN");?> :
	                   </label>
	                   <div class="col-md-7 col-sm-7 col-xs-12">
	                   		<?php echo $frm->getElement('remain');?>
	                   </div>
	                </div>
	                <div class="form-group">
	                   <label class="control-label col-md-5 col-sm-5 col-xs-12" >
	                   <?php echo $tr->translate("CHEQUE");?> :
	                   </label>
	                   <div class="col-md-7 col-sm-7 col-xs-12">
	                   		<?php echo $frm->getElement('cheque');?>
	                   </div>
	                </div>
	            </div>
	             <div class="col-md-4 col-sm-4 col-xs-12">
					<div class="form-group">
	                   <label class="control-label col-md-12 col-sm-12 col-xs-12 title-blog bold" ><i class="fa fa-hand-o-right" aria-hidden="true"></i> <?php echo $tr->translate("PAYMENT_INFORMATION");?> 
	                   </label>
	                </div>
	                <div class="form-group">
	                   <label class="control-label col-md-5 col-sm-5 col-xs-12" ><?php echo $tr->translate("COLLECT_DATE");?> :
	                   </label>
	                   <div class="col-md-7 col-sm-7 col-xs-12">
	                   		<?php echo $frm->getElement('collect_date');?>
	                   </div>
	                </div>
	                <div class="form-group">
	                   <label class="control-label col-md-5 col-sm-5 col-xs-12" >
	                   <?php echo $tr->translate("បង់លើក");?> :
	                   </label>
	                   <div class="col-md-7 col-sm-7 col-xs-12">
	                   		<?php echo $frm->getElement('paid_times');?>
	                   </div>
	                </div>
	                <div class="form-group">
	                   <label class="control-label col-md-5 col-sm-5 col-xs-12" >
	                   <?php echo $tr->translate("PAYMENT_OPTION");?> :
	                   </label>
	                   <div class="col-md-7 col-sm-7 col-xs-12">
	                   		<?php  echo $frm->getElement('option_pay');?>
	                   </div>
	                </div>
	                <div class="form-group">
	                   <label class="control-label col-md-5 col-sm-5 col-xs-12" >
	                   <?php echo $tr->translate("TOTAL_PENELIZE");?> :
	                   </label>
	                   <div class="col-md-7 col-sm-7 col-xs-12">
	                   	<?php echo $frm->getElement('penalize_amount');?>
	                   	<?php echo $frm->getElement('old_penelize');?>
	                   	<input type="hidden" name="new_penelize" id="new_penelize">
	                   </div>
	                </div>
	                <div class="form-group">
	                   <label class="control-label col-md-5 col-sm-5 col-xs-12" >
	                   <?php echo $tr->translate("TOTAL_RECIEPT");?> :
	                   </label>
	                   <div class="col-md-7 col-sm-7 col-xs-12">
	                   	<?php echo $frm->getElement('amount_receive');?>
	                   </div>
	                </div>
	                <div class="form-group">
	                   <label class="control-label col-md-5 col-sm-5 col-xs-12" >
	                   <?php echo $tr->translate("NOTE");?> :
	                   </label>
	                   <div class="col-md-7 col-sm-7 col-xs-12">
	                   		<?php echo $frm->getElement('note');?>
	                   </div>
	                </div>
	            </div>
			</div>
			<div class="card-box">
				<div class="col-md-12 col-sm-12 col-xs-12">
					<div class="form-group" style="overflow:hidden;max-width:1200;">
				<style>
				.dijitTabPaneWrapper , .dijitContentPane,.dijitTabListContainer-top{max-width: 99% !important;}
				</style>
					<div style="width:100%;" class="tabContentSection"  title="<?php echo $tr->translate('SCHEDULE_PAYMENTUNPAID');?>" selected="true">
						<div id='data_table' name='data_table'></div>
					</div>
					</div>
				</div>
			</div>
			<div class="clearfix"></div>
			    <div class="card-box">
               		<div class="col-sm-12 border-top mt-20 ptb-10 text-center">
		    			<input type="button" value="រក្សាទុក & បិទ" label="<?php echo $tr->translate('SAVECLOSE');?>" id="submit_close" dojoType="dijit.form.Button"
					iconClass="dijitEditorIcon dijitEditorIconSave"  OnClick="submitDataClose();" />
			    <input type="submit" value="រក្សាទុក" label="<?php echo $tr->translate('SAVENEW');?>" id="submitButton" dojoType="dijit.form.Button"
					iconClass="dijitEditorIcon dijitEditorIconSave" />
			    <input type="button" value="រក្សាទុក & បោះពុម្ព" label="<?php echo $tr->translate('SAVEPRINT');?>" id="saveprint" dojoType="dijit.form.Button" 
					iconClass="dijitEditorIcon dijitEditorIconPrint" onClick="showReciept('');displayNone();"/>
	    		</div>
	    	</div>
		</form>
    </div>
</div>
<div class="dijitHidden" style="width:24cm;padding: 0px; margin: 0px;">
	<div data-dojo-type="dijit.Dialog" style="width:22cm !important; text-align:center;" data-dojo-props="title:'បោះពុម្ភ វិក័យបត្រ', onCancel:hideDialog" id="frm_client">
		<div id="rpt_print" >
			<table cellpadding="0" cellspacing="0" style="width:20cm; white-space:nowrap; font-family:'Khmer OS Battambang'; font-size: 16px;">
				<tr valign="top" >
					<td align="center" colspan="6" valign="top" >	
						<table  cellpadding="0" cellspacing="0" style=" font-family: 'Khmer OS Battambang';padding:0; width:100%;white-space:nowrap;">
							<tr style="line-height:10px;">
								<td valign="top" width="25%" align="left" style="color: #000;">
									<img style="height:75px;margin-bottom: -25px;margin-top: -10px;" src="<?php echo $this->baseUrl().'/images/bppt_logo.png'?>">
								</td>
								<td width="50%" valign="top" align="center" style="color: #000;">
									<span style="text-align:center; font-size:18px !important; font-family:'Khmer MEF2';text-decoration:none;"><?php echo $tr->translate("PAYMENT_RECEIPT");?></span><br />
									<span style="text-align:center;line-height:30px; font-size:16px !important;font-family:sans-serif;text-decoration:none;">OFFICIAL RECEIPT</span>
								</td>
								<td width="25%"  style="color: #000;">&nbsp;
								</td>
							</tr>
						</table>
					</td>
				</tr> 
				<tr>
						<td align="center" colspan="6" valign="top" >	
							<table width="100%" cellpadding="0" cellspacing="3px" style="font-family: 'Khmer OS Battambang' ;font-size:16px !important;white-space:nowrap; margin-top: -35px;">
								<tr class="fontsize" >
										<td class="fontsize" valign="top"></td>
										<td ></td>
										<td></td>
										<td ></td>
										<td></td>
										<td align="right"><strong><label id="lbl_reciept_no" class="value"></label></strong></td>
								</tr>
								<tr class="fontsize" >
										<td style="width:10%;"  >លេខកូដលក់</td>
										<td style="width:40%;border:1px solid #000;font-size: 14px;">&nbsp;&nbsp;<strong><label id="lbl_loan_number" class="value"></label></strong></td>
										<td  style="width:10%;" class="padding">ប្រាក់ដើមត្រូវបង់</td>
										<td style="border:1px solid #000;">&nbsp;&nbsp;<strong><label id="lbl_principle_amount" class="value"></label></strong></td>
										<td  >បង់លើកទី</td>
										<td style="border:1px solid #000;"><strong>&nbsp;&nbsp;<label id="lbl_paidtimes" class="value"></label></strong></td>
								</tr>
								<tr class="fontsize" >
										<td >ឈ្មោះ​អតិថិជន</td>
										<td style="border:1px solid #000;"><strong>&nbsp;&nbsp;<label id="lbl_client_id" class="value"></label></strong></td>
										<td  class="padding">ប្រាក់ការ</td>
										<td style="border:1px solid #000;"><strong>&nbsp;&nbsp;<label id="lbl_total_interest" class="value"></label></strong></td>
										<td  >ប្រាក់ពិន័យ</td>
										<td style="border:1px solid #000;"><strong>&nbsp;&nbsp;<label id="lbl_penalize" class="value"></label></strong></td>
								</tr>
								<tr class="fontsize">
										<td >លេខឡូតិ៍/ផ្ទះ</td>
										<td style="border:1px solid #000;white-space: normal;line-height: 20px;"><strong>&nbsp;&nbsp;<label id="lbl_property_address" class="value"></label></strong></td>
										<td class="padding">ប្រាក់បង់បន្ថែម</td>
							    		<td colspan="3" style="width:40%;border:1px solid #000;">&nbsp;&nbsp;<strong><label id="lbl_extrapayment" class="value"></label></strong></td>
								</tr>
								<tr class="fontsize">
										<td  >តំលៃឡូតិ៍/ផ្ទះ</td>
										<td style="border:1px solid #000;"><strong>&nbsp;&nbsp;<label id="lbl_property_price" class="value"></label></strong></td>
										<td class="padding">ប្រាក់ត្រូវបង់សរុប</td>
										<td colspan="3" style="border:1px solid #000;">&nbsp;&nbsp;<strong><label id="lbl_total_payment" class="value" style="font-weight: bold;font-family: Arial;"></label></strong></td>
								</tr>
								<tr class="fontsize">
										<td >ប្រាក់បានបង់សរុប</td>
										<td style="border:1px solid #000;" ><strong>&nbsp;&nbsp;<label id="lbl_total_paid" class="value"></label></strong></td>
										<td class="padding">ប្រាក់បានបង់</td>
										<td colspan="3" style="border:1px solid #000;" colspan="3">&nbsp;&nbsp;<strong><label id="lbl_total_receive" class="value"></label></strong></td>
						        </tr>
								<tr class="fontsize">
										<td  >ប្រាក់នៅសល់</td>
										<td style="border:1px solid #000;"><strong>&nbsp;&nbsp;<label id="lbl_ending_balance" class="value"></label></strong></td>
										
										<td class="padding">ថ្ងៃត្រូវបង់</td>
										<td style="border:1px solid #000;" ><strong>&nbsp;<label id="lbl_date_payment" class="value"></label></strong></td>
										<td>ថ្ងៃទទួល</td>
										<td style="border:1px solid #000;" ><strong>&nbsp;<label id="lbl_paid_date" class="value"></label></strong></td>
								</tr>
								<tr class="fontsize">			
										<td  >សំគាល់</td>
										<td  style="border:1px solid #000;"><strong>&nbsp;&nbsp;<label id="lbl_note" class="value"></label></strong></td>
										<td class="padding">បង់ជា</td>
										<td style="border:1px solid #000;"><strong>&nbsp;&nbsp;<label id="lbl_paymentmethod" class="value"></label></strong></td>
										<td>លេខ</td>
										<td style="border:1px solid #000;" ><strong>&nbsp;<label id="lbl_cheque" class="value"></label></strong></td>
								
								</tr>
								<tr>
									<td colspan="6">
										<table width="100%" border="0" style="font-size:14px;line-height: 18px;">
											<tr>
												<td width="30%">&nbsp;
													<?php echo $this->data['account_sign'];?>
												</td>
												<td align="center" width="40%">
													<?php echo $this->data['customer_sign'];?>
												</td>
												<td align="center" width="30%">
													<?php echo $this->data['teller_sign'];?>
												</td>
											</tr>
											<tr height="80px">
												<td colspan="3">&nbsp;
												</td>
											</tr>
											<tr>
												<td width="30%">&nbsp;
												</td>												
												<td align="center" width="40%">
													<strong><label id="lbl_client_name" class="value"></label></strong>
												</td>
												<td align="center" width="30%">
													<strong>
														<?php 
														   $session_user=new Zend_Session_Namespace(SYSTEM_SES);
														   $last_name=$session_user->last_name;
														   $username = $session_user->first_name;
														   echo $last_name." ".$username;
														?>
													</strong>
												</td>
											</tr>
										</table>
									</td>
								</tr>
								<tr style="line-height: 20px;font-size: 11px;">
									<td valign="top" >
										<span style="text-decoration:underline;font-size: 14px;">សំគាល់ ៖</span>
									</td>
									<td colspan="5">
										<span style="font-size: 11px;"><?php echo $this->data['comment'];?></span><br />
										<span style="white-space: pre-line;font-size: 11px;"><?php echo $this->data['comment1'];?></span><br />
									</td>
								</tr>
								<tr style="line-height: 10px;font-size: 10px;">
									<td colspan="6" style="border: 1px solid rgba(255, 235, 59, 0.88)">										
									</td>
								</tr>
								<tr >
									<td colspan="6" >
										<table width="100%" style="font-family:'Khmer OS Battambang'; font-size:10px;line-height: 10px;margin-top: -5px;margin-bottom:15px;"> 
											<tr>
												<td width="22%">
													<img style="width:70%;height: 25px;" src="<?php echo $this->baseUrl().'/images/bppt_letter.png'?>">
												</td>
												<td width="40%">
													<span style=""><?php echo $this->data['website'];?></span>
												</td>
												<td width="40%" align="right">
													<span style="font-family: 'Khmer OS Battambang';"><?php echo $this->data['email_client'];?></span>
												</td>
											</tr>
											<tr style="white-space:nowrap;">
												<td colspan="2">
													<?php echo $this->data['footer_branch'];?>
												</td>
												<td width="40%" align="right">
													<span style="white-space: normal;"><?php echo $this->data['tel-client'];?></span>
												</td>
											</tr>
										</table>
									</td>
								</tr>
								<tr>
									<td colspan="6" style="border-top:2px dashed #000;" >
									</td>
								</tr>
							</table>
						</td>
				</tr>
			</table>
		</div>
			<iframe name=print_frame width=0 height=0 frameborder=0 src=about:blank></iframe>
			<table width="100%">
				<tr>
					<td align="center"><input type="button" value="បិទ" label="បិទ" id="close" dojoType="dijit.form.Button" 
							iconClass="dijitEditorIcon dijitEditorIconCancel" onClick="hideDialog();"/>
						<input type="button" value="បោះពុម្ព" label="បោះពុម្ព" id="print" dojoType="dijit.form.Button" 
							iconClass="dijitEditorIcon dijitEditorIconPrint" onClick="print();"/>
					<td>
				<tr>
			</table>
		<div id="rpt_print1" >
			<table cellpadding="0" cellspacing="0" style="width:100%;margin-top:0px;white-space:nowrap; font-family:'Khmer OS Battambang'; font-size: 12px;">
				<tr valign="top" >
					<td align="center" colspan="6" valign="top" >	
						<table cellpadding="0" cellspacing="0" style="font-family: 'Khmer OS Battambang';padding:0; width:100%;white-space:nowrap;">
									<tr style="line-height:20px;">
										<td valign="top" width="25%" align="left" style="color: #000;">
											<img style="height:75px;margin-bottom: -25px;margin-top: -10px;" src="<?php echo $this->baseUrl().'/images/bppt_logo.png'?>">
										</td>
										<td width="50%" valign="top" align="center" style="color: #000;">
											<span style="text-align:center; font-size:18px !important; font-family:'Khmer MEF2';text-decoration:none;"><?php echo $tr->translate("PAYMENT_RECEIPT");?></span><br />
											<span style="text-align:center; font-size:16px !important;line-height:30px; text-decoration:none;">OFFICIAL RECEIPT</span>
										</td>
										<td width="25%"  style="color: #000;">&nbsp;
										</td>
									</tr>
						</table>
					</td>
				</tr> 
				<tr>
						<td align="center" colspan="6" valign="top" >	
							<table width="100%" cellpadding="0" cellspacing="3px" style=" margin-top:-10px;font-family: 'Khmer OS Battambang';font-size:16px !important;white-space:nowrap;margin-top: -25px;">
								<tr class="fontsize" style="border:1px solid #000;">
									<td class="fontsize" valign="top"></td>
									<td ></td>
									<td></td>
									<td ></td>
									<td></td>
									<td align="right"><strong><label id="lbl_reciept_no1" class="value"></label></strong></td>
								</tr>
								<tr class="fontsize" style="border:1px solid #000;">
									<td style="width:10%;"  >លេខកូដលក់</td>
									<td style="width:40%;border:1px solid #000;font-size: 14px;">&nbsp;&nbsp;<strong><label id="lbl_loan_number1" class="value"></label></strong></td>
									<td  style="width:10%;" class="padding">ប្រាក់ដើមត្រូវបង់</td>
									<td style="border:1px solid #000;">&nbsp;&nbsp;<strong><label id="lbl_principle_amount1" class="value"></label></strong></td>
									<td  >បង់លើកទី</td>
									<td style="border:1px solid #000;"><strong>&nbsp;&nbsp;<label id="lbl_paidtimes1" class="value"></label></strong></td>
								</tr>
								<tr class="fontsize" style="border:1px solid #000;">
									<td >ឈ្មោះ​អតិថិជន</td>
									<td style="border:1px solid #000;"><strong>&nbsp;&nbsp;<label id="lbl_client_id1" class="value"></label></strong></td>
									<td  class="padding">ប្រាក់ការ</td>
									<td style="border:1px solid #000;"><strong>&nbsp;&nbsp;<label id="lbl_total_interest1" class="value"></label></strong></td>
									<td  >ប្រាក់ពិន័យ</td>
									<td style="border:1px solid #000;"><strong>&nbsp;&nbsp;<label id="lbl_penalize1" class="value"></label></strong></td>
								</tr>
								<tr class="fontsize">
									<td >លេខឡូតិ៍/ផ្ទះ</td>
									<td style="border:1px solid #000;"><strong>&nbsp;&nbsp;<label id="lbl_property_address1" class="value"></label></strong></td>
									<td class="padding">ប្រាក់បង់បន្ថែម</td>
									<td colspan="3" style="width:40%;border:1px solid #000;">&nbsp;&nbsp;<strong><label id="lbl_extrapayment1" class="value"></label></strong></td>
								</tr>
								<tr class="fontsize">
									<td>តំលៃឡូតិ៍/ផ្ទះ</td>
									<td style="border:1px solid #000;"><strong>&nbsp;&nbsp;<label id="lbl_property_price1" class="value"></label></strong></td>
									<td class="padding">ប្រាក់ត្រូវបង់សរុប</td>
									<td colspan="3" style="border:1px solid #000;">&nbsp;&nbsp;<strong><label id="lbl_total_payment1" class="value" style="font-weight: bold;font-family: Arial;"></label></strong></td>
								</tr>
								<tr class="fontsize">
									<td >ប្រាក់បានបង់សរុប</td>
									<td style="border:1px solid #000;" ><strong>&nbsp;&nbsp;<label id="lbl_total_paid1" class="value"></label></strong></td>
						 			<td class="padding">ប្រាក់បានបង់</td>
									<td colspan="3" style="border:1px solid #000;" colspan="3">&nbsp;&nbsp;<strong><label id="lbl_total_receive1" class="value"></label></strong></td>
							   </tr>
								<tr class="fontsize">
									<td  >ប្រាក់នៅសល់</td>
									<td style="border:1px solid #000;"><strong>&nbsp;&nbsp;<label id="lbl_ending_balance1" class="value"></label></strong></td>
									<td class="padding">ថ្ងៃត្រូវបង់</td>
									<td style="border:1px solid #000;" ><strong>&nbsp;<label id="lbl_date_payment1" class="value"></label></strong></td>
									<td>ថ្ងៃទទួល</td>
									<td style="border:1px solid #000;" ><strong>&nbsp;<label id="lbl_paid_date1" class="value"></label></strong></td>
								</tr>
								<tr class="fontsize">			
									<td  >សំគាល់</td>
									<td  style="border:1px solid #000;"><strong>&nbsp;&nbsp;<label id="lbl_note1" class="value"></label></strong></td>
									<td class="padding">បង់ជា</td>
									<td style="border:1px solid #000;" ><strong>&nbsp;&nbsp;<label id="lbl_paymentmethod1" class="value"></label></strong></td>
									<td class="padding">លេខ</td>
									<td style="border:1px solid #000;" ><strong>&nbsp;&nbsp;<label id="lbl_cheque1" class="value"></label></strong></td>
								</tr>
								<tr>
									<td colspan="6">
										<table width="100%" border="0" style="font-size: 14px;line-height: 18px;">
											<tr>
												<td width="30%">&nbsp;
													<?php echo $this->data['account_sign'];?>
												</td>
												<td align="center" width="40%">
													<?php echo $this->data['customer_sign'];?>
												</td>
												<td align="center" width="30%">
													<?php echo $this->data['teller_sign'];?>
												</td>
											</tr>
											<tr height="80px">
												<td colspan="3">&nbsp;
												</td>
											</tr>
											<tr>
												<td width="30%">&nbsp;
													
												</td>
												<td align="center" width="40%">
													<strong><label id="lbl_client_name1" class="value"></label></strong>
												</td>
												<td align="center" width="30%">
													<strong>
														<?php 
														   $session_user=new Zend_Session_Namespace(SYSTEM_SES);
														   $last_name=$session_user->last_name;
														   $username = $session_user->first_name;
														   echo $last_name." ".$username;
														?>
													</strong>
												</td>
											</tr>
										</table>
									</td>
								</tr>
								
								<tr style="line-height: 20px;font-size: 11px;">
									<td valign="top" >
										<span style="text-decoration:underline;font-size: 14px;">សំគាល់ ៖</span>
									</td>
									<td colspan="5">
										<span style="font-size: 11px;"><?php echo $this->data['comment'];?></span><br />
										<span style="white-space: pre-line;font-size: 11px;"><?php echo $this->data['comment1'];?></span><br />
									</td>
								</tr>
								<tr style="line-height: 10px;font-size: 10px;">
									<td colspan="6" style="border: 1px solid rgba(255, 235, 59, 0.88)">
										
									</td>
								</tr>
								
								<tr >
									<td colspan="6" >
										<table width="100%" style="font-family:'Khmer OS Battambang'; font-size:10px;line-height: 15px;margin-top: -5px;margin-bottom:15px;"> 
											<tr>
												<td width="22%">
													<img style="width:70%;height: 25px;" src="<?php echo $this->baseUrl().'/images/bppt_letter.png'?>">
												</td>
												<td width="40%">
													<span style=""><?php echo $this->data['website'];?></span>
												</td>
												<td width="40%" align="right">
													<span style="font-family: 'Khmer OS Battambang';"><?php echo $this->data['email_client'];?></span>
												</td>
											</tr>
											<tr style="white-space:nowrap;">
												<td colspan="2">
													<?php echo $this->data['footer_branch'];?>
												</td>
												<td width="40%" align="right">
													<span style="white-space: normal;"><?php echo $this->data['tel-client'];?></span>
												</td>
											</tr>
										</table>
									</td>
								</tr>
							</table>
						</td>
				</tr>
			</table>
		</div>	
		
	</div>
</div>
<?php $baseurl =  Zend_Controller_Front::getInstance()->getBaseUrl();?>
<script type="text/javascript">
var graice_period = <?php echo $graiceperiod["value"] ?>;
function submitDataClose(){
	var url_submit = '<?php echo $this->url(array('module'=>'loan','controller'=>'customerpayment','action'=>'add')); ?>';
	service_charge = dijit.byId('service_charge').get('value');
	receive_amount = dijit.byId('amount_receive').get('value');
	option_pay = dijit.byId('option_pay').get('value');
	total_payments = dijit.byId('total_payment').get('value');
	if(option_pay==2 || option_pay==3 || option_pay==4){
		if(receive_amount<total_payments){
			alert('You Can not pay in this option! Please Input Recieve Amount more than or equal Total Payment!');
			dijit.byId('amount_receive').focus();
			return false;
		}
	}
	if(receive_amount<0){
		alert('Please fill Recieve Amount');
		dijit.byId('amount_receive').focus();
		return false;
	}
		loading();
		dojo.xhrPost({
		    url: url_submit,	
			form: dojo.byId("frm_add_group_pay"),		    
			load: function(data) {
				HideloadingBlock();
				alert('<?php echo $tr->translate('INSERT_SUCCESS');?> !');
				window.location.href ="<?php echo $this->baseUrl();?>/loan/customerpayment";
			},
			error: function(e) {
			}
		});
}
function submitData(){
	var url_submit = '<?php echo $this->url(array('module'=>'loan','controller'=>'customerpayment','action'=>'add')); ?>';
	service_charge = dijit.byId('service_charge').get('value');
	receive_amount = dijit.byId('amount_receive').get('value');
	option_pay = dijit.byId('option_pay').get('value');
	total_payments = dijit.byId('total_payment').get('value');
	if(option_pay==2 || option_pay==3 || option_pay==4){
		if(receive_amount<total_payments){
			alert('You Can not pay in this option! Please Input Recieve Amount more than or equal Total Payment!');
			dijit.byId('amount_receive').focus();
			return false;
		}
	}
	if(receive_amount<0){
		alert('Please fill Recieve Amount');
		dijit.byId('amount_receive').focus();
		return false;
	}
	loading();
	dojo.xhrPost({
		    url: url_submit,	
			form: dojo.byId("frm_add_group_pay"),		    
			load: function(data) {
				HideloadingBlock();
				alert('<?php echo $tr->translate('INSERT_SUCCESS');?> !');
				window.location.href ="<?php echo $this->baseUrl();?>/loan/customerpayment/add";
			},
			error: function(e) {
			}
		});
}
function displayNone(){
	document.getElementById('rpt_print1').style.display="none";
}
function showReciept(receipt_number){
	amount_receive = dijit.byId('amount_receive').get('value');
	if(amount_receive<=0){
		alert("មិនអាចចេញបង្កាន់ដៃបង់ប្រាក់បានទេ ។សូមត្រួតពិនិត្យមើលទិន្នន័យម្តងទៀត!");
		dijit.byId('amount_receive').focus();
		return false;
	}
	if(dijit.byId('frm_add_group_pay').validate()){
            service_charge = dijit.byId('service_charge').get('value');
			receive_amount = dijit.byId('amount_receive').get('value');
			option_pay = dijit.byId('option_pay').get('value');
			total_payments = dijit.byId('total_payment').get('value');
			if(option_pay==2 || option_pay==3 || option_pay==4){
				if(receive_amount<total_payments){
					alert('You Can not pay in this option! Please Input Recieve Amount more than or equal Total Payment!');
					dijit.byId('amount_receive').focus();
					return false;
				}
			}
			if(receive_amount<0){
				alert('Please fill Recieve Amount');
				dijit.byId('amount_receive').focus();
				return false;
			}
	var date_payment = '';
	var client_id = dijit.byId('client_id').get('value');
	if(client_id==""){
		alert("មិនអាចចេញបង្កាន់ដៃបង់ប្រាក់បានទេ ។សូមត្រួតពិនិត្យមើលទិន្នន័យម្តងទៀត!");
		return false;
	}else{
		date_payment = dijit.byId('collect_date').get('value');
		var format_date_payment = new Date(date_payment);
		day = format_date_payment.getDate();
		month = format_date_payment.getMonth() + 1;
		month = returnMOnth(month);
		year = format_date_payment.getFullYear();
		collect_payment = day+'-'+month+'-'+year;
		
		symbal = " $";
		option_pay = dijit.byId('option_pay').get('value');
		if(option_pay==1){
			date_payment = $('#date_payment_1').val();
			var format_date_payment = new Date(date_payment);
			day = format_date_payment.getDate();
			month = format_date_payment.getMonth() + 1;
			month = returnMOnth(month);
			year = format_date_payment.getFullYear();
			date_payment = day+'-'+month+'-'+year;
			total_payment = dijit.byId('total_payment').get('value');
			total_received = dijit.byId('amount_receive').get('value');
			if(total_received<total_payment){
				
				penelize = dijit.byId('penalize_amount').get('value');
				service_charge = dijit.byId('service_charge').get('value');
				interest = dijit.byId('total_interest').get('value');
				begining_balance = $('#total_priciple_1').val();
				os_amount = total_received - penelize - service_charge - interest;
				ending_balance = begining_balance - os_amount;
			}else{
				ending_balance = dijit.byId('priciple_amount').get('value');
			}
		}else{
			ending_balance = 0;
			date_payment = dijit.byId("datepaymentlastrecord").get('value');
			var format_date_payment = new Date(date_payment);
			month = format_date_payment.getMonth() + 1;
			month = returnMOnth(month);
			day = format_date_payment.getDate();
			if(day<10){
				day = '0'+day;
			}
			year = format_date_payment.getFullYear();
			date_payment = day+'-'+month+'-'+year;
		}
		document.getElementById('lbl_client_id').innerHTML = dijit.byId('client_id').attr('displayedValue');
		document.getElementById('lbl_note').innerHTML = dijit.byId('note').get('value');
	 	document.getElementById('lbl_cheque').innerHTML = dijit.byId('cheque').get('value');
	 	document.getElementById('lbl_client_id1').innerHTML = dijit.byId('client_id').attr('displayedValue');
		document.getElementById('lbl_date_payment1').innerHTML = date_payment;
		document.getElementById('lbl_note1').innerHTML = dijit.byId('note').get('value');
	 	document.getElementById('lbl_cheque1').innerHTML = dijit.byId('cheque').get('value');
	 	document.getElementById('lbl_paid_date1').innerHTML = collect_payment;//dijit.byId('collect_date').attr('displayedValue');
	 	document.getElementById('lbl_principle_amount').innerHTML = dojo.number.format(dijit.byId('os_amount').get('value'),{places:2})+symbal;
		document.getElementById('lbl_total_interest').innerHTML = dojo.number.format(dijit.byId('total_interest').get('value'),{places:2})+symbal;
		document.getElementById('lbl_date_payment').innerHTML = date_payment;
		document.getElementById('lbl_paid_date').innerHTML = collect_payment;//dijit.byId('collect_date').attr('displayedValue');

	 	document.getElementById('lbl_principle_amount1').innerHTML = dojo.number.format(dijit.byId('os_amount').get('value'),{places:2})+symbal;
		document.getElementById('lbl_total_interest1').innerHTML = dojo.number.format(dijit.byId('total_interest').get('value'),{places:2})+symbal;
		document.getElementById('lbl_total_interest').innerHTML = dojo.number.format(dijit.byId('total_interest').get('value'),{places:2})+symbal;
		document.getElementById('lbl_penalize').innerHTML = dojo.number.format(dijit.byId('penalize_amount').get('value'),{places:2})+symbal;
		
		all_paid = receive_amount+parseFloat(dijit.byId("total_pricipalpaid").get("value"));
		document.getElementById('lbl_total_paid').innerHTML = dojo.number.format(all_paid,{places:2}) + symbal;
		document.getElementById('lbl_total_paid1').innerHTML = dojo.number.format(all_paid,{places:2}) + symbal;
	 	
		document.getElementById('lbl_reciept_no').innerHTML = receipt_number;

		document.getElementById('lbl_total_interest1').innerHTML = dojo.number.format(dijit.byId('total_interest').get('value'),{places:2})+symbal;
		document.getElementById('lbl_penalize1').innerHTML = dojo.number.format(dijit.byId('penalize_amount').get('value'),{places:2})+symbal;
		
		document.getElementById('lbl_reciept_no1').innerHTML = receipt_number;
		document.getElementById('lbl_client_name1').innerHTML = dijit.byId('client_id').attr('displayedValue');
		document.getElementById('lbl_client_name').innerHTML = dijit.byId('client_id').attr('displayedValue');
		document.getElementById('lbl_total_payment').innerHTML = dojo.number.format(dijit.byId('total_payment').get('value'),{places:2})+symbal;				
		document.getElementById('lbl_total_payment1').innerHTML = dojo.number.format(dijit.byId('total_payment').get('value'),{places:2})+symbal;				
		document.getElementById('lbl_total_receive').innerHTML = dojo.number.format(dijit.byId('amount_receive').get('value'),{places:2})+symbal;
		document.getElementById('lbl_total_receive1').innerHTML = dojo.number.format(dijit.byId('amount_receive').get('value'),{places:2})+symbal;
		
		extra_payment = dijit.byId("extrapayment").get("value");
		extra_payment = isNaN(extra_payment)?0:extra_payment;
		document.getElementById('lbl_extrapayment').innerHTML = dojo.number.format(extra_payment,{places:2})+symbal;
		document.getElementById('lbl_extrapayment1').innerHTML = dojo.number.format(extra_payment,{places:2})+symbal;
		
	 	var rowId = $('#identity').val();
	 	land_name='';
	 	sale_code ='';
		if(rowId!=''){
			tem='';
			var rowIDArray = rowId.split(',');
			record = 0;
			sign='';
			price_sold=0;
			set=0;
			for(var n = 0; n < rowIDArray.length; n++) {
				record=record+1;
				//if($('#mfdid_'+rowIDArray[n]).attr('checked')){
				if ($('#mfdid_'+rowIDArray[n]).is(':checked')) {
					if(set>0){sign="/ ";}
					set=1;
					land_name+= sign+$('#land_name'+rowIDArray[n]).val();
					sale_code+= sign+$('#sale_code'+rowIDArray[n]).val();
					price_sold=price_sold+parseFloat($('#price_sold'+rowIDArray[n]).val());
				}
				
			}
			document.getElementById('lbl_loan_number').innerHTML = sale_code;
			document.getElementById('lbl_loan_number1').innerHTML = sale_code;
			
			
			document.getElementById('lbl_property_address').innerHTML = land_name;
			document.getElementById('lbl_property_address1').innerHTML = land_name;
			document.getElementById('lbl_property_price').innerHTML = dojo.number.format(price_sold,{places:2})+symbal;
			document.getElementById('lbl_property_price1').innerHTML = dojo.number.format(price_sold,{places:2})+symbal;
			
			total_balance = price_sold - parseFloat(all_paid)+parseFloat(extra_payment);
			
			document.getElementById('lbl_ending_balance').innerHTML = dojo.number.format(total_balance,{places:2})+symbal;
			document.getElementById('lbl_ending_balance1').innerHTML = dojo.number.format(total_balance,{places:2})+symbal;
	  }
		
		if(receipt_number==''){
			getReceiptNumber(1);
		}
		document.getElementById('lbl_paidtimes').innerHTML = dijit.byId("paid_times").get("value");
		document.getElementById('lbl_paidtimes1').innerHTML = dijit.byId("paid_times").get("value");
		
		dijit.byId('frm_client').show();
	}
 }
}
function returnMOnth(monthnum){
	var month = new Array();
	month[1] = "Jan";month[2] = "Feb";month[3] = "Mar";month[4] = "Apr";month[5] = "May";
	month[6] = "Jun";month[7] = "Jul";month[8] = "Aug";month[9] = "Sep";
	month[10] = "Oct";month[11] = "Nov";month[12] = "Dec";
	return month[monthnum];
}
dojo.ready(function(){	
		new dijit.form.FilteringSelect({
			autoComplete: true,
			required: false,		           
			name: "loan_number",
			id: "loan_number",
			searchAttr: "name",
			class: 'fullside',
			onChange: function() {
				getLaonPayment(1);//ទាញយកប្រាក់មិនទាន់បង់
				dijit.byId("amount_receive").focus();
			}
		}, "loan_number");
		
	var client_data = new dojo.store.Memory({
	       data: <?php print_r(Zend_Json::encode($this->client));?>
	});
	new dijit.form.FilteringSelect({
	store: dojo.data.ObjectStore({objectStore: client_data}),
	autoComplete: true,
	required: false,		           
	name: "client_id",
	id: "client_id",
	searchAttr: "name",
	class: 'fullside',
	onChange: function() {
		getLaonPayment(3);
		if(not_submit==0){
	   }
}
	}, "client_id");

	var clientCode_data = new dojo.store.Memory({
	       data: <?php print_r(Zend_Json::encode($this->clientCode));?>
	});
	new dijit.form.FilteringSelect({
	store: dojo.data.ObjectStore({objectStore: clientCode_data}),
	autoComplete: true,	            
	required: false,		           
	name: "client_code",
	id: "client_code",
	searchAttr: "name",
	class: 'fullside',
	onChange: function() {
		if(not_submit==0){
		}
	}
	}, "client_code");
    not_submit = 0;
	<?php if(!empty($this->rsresult)){?>
		dijit.byId('branch_id').attr('value','<?php echo $this->rsresult['branch_id'];?>');
	<?php }?>
	dijit.byId('branch_id').attr('value',1);	
});
var url_getlastpaiddate = '<?php echo $this->url(array('module'=>'loan','controller'=>'ilpayment','action'=>'get-lastpaiddate')); ?>';
function getLastPaidDate(){
	dojo.xhrPost({
		url:url_getlastpaiddate,	
		content:{ 
		    'loan_number':0//dijit.byId('loan_number').get('value')
		},		    
		handleAs:"json",
		load: function(data) {
			if(data==''){
				dijit.byId('lastpaiddate').attr('value','');
				dijit.byId('datepaymentlastrecord').attr('value','');
			}else{
				dijit.byId('lastpaiddate').attr('value',data.date_pay);		
				dijit.byId('datepaymentlastrecord').attr('value',data.datepaymentlastrecord);
			}
		},
		error: function(err) {
			alert(err);
		}
	});
}
var sale_number_store  = getDataStorefromJSON('id','name', <?php print_r(array())?> );

function filterLoanNumber(){
	 dijit.byId('loan_number').query.branch_id = dijit.byId('branch_id').get('value');
}
function filterClient(){
	branch_id = dijit.byId('branch_id').get('value');
	dijit.byId('client_id').query.branch_id = branch_id;
	dijit.byId('client_code').query.branch_id = branch_id;
}
    var tran_store  = getDataStorefromJSON('','name',null);
	var tran_status = {};	
	function print(){
		window.frames["print_frame"].document.body.innerHTML=dojo.byId('rpt_print').innerHTML + dojo.byId('rpt_print1').innerHTML;
	    window.frames["print_frame"].window.focus();
	    window.frames["print_frame"].window.print();
		//dijit.byId("frm_add_group_pay").submit();
		submitData();
	    //hideDialog();
	}
	function hideDialog() {		
		dijit.byId("frm_client").hide();
	}
	// Force them to provide an answer
	function doPrint() {
		window.frames["print_frame"].document.body.innerHTML=dojo.byId('rpt_print').innerHTML;
	    window.frames["print_frame"].window.focus();
	    window.frames["print_frame"].window.print();
	}
</script>
<script type="text/javascript">
function getAllSaleNumber(){
}
function clearTextBox(){
	dijit.byId('member').set('value','');
	dijit.byId('total_amount').set('value',0);
}
function payOption(){
	var ids =dijit.byId('record_id').get('value');
	var arrays = ids.split(',');
	for(var i=0;i<arrays.length;i++){
    	for(var i=0;i<arrays.length;i++) {
 			trRow(arrays[i]);
    	}
	}
}
function trRow(x){
	pay_option = dijit.byId('option_pay').get('value');
	if(pay_option==1){
		dijit.byId('identity').attr('value',1);
		if(x==1){
			document.getElementById('tr_'+x).style.background='none';
			$('#mfdid_'+x).attr('checked',true);
			$('#mfdid_'+x).attr('onclick',"return true", 'onkeydown',"return true");
		}else{
			document.getElementById('tr_'+x).style.background='#eee';
			$('#mfdid_'+x).attr('checked',false);
			$('#mfdid_'+x).attr('onclick',"return false", 'onkeydown',"return false");
		}
		$('#check_all').attr('onclick',"return true", 'onkeydown',"return false");
	}else if(pay_option==4){
			$('#mfdid_'+x).attr('onclick',"return false", 'onkeydown',"return false");
		document.getElementById('tr_'+x).style.background='#eee';
		$('#mfdid_'+x).attr('checked',true);
		$('#check_all').attr('checked',true);
	}else{
		document.getElementById('tr_'+x).style.background='none';
		$('#mfdid_'+x).attr('onclick',"return true", 'onkeydown',"return true");
		$('#check_all').attr('onclick',"return true", 'onkeydown',"return true");
		$('#check_all').attr('checked',false);
		if(x==1){
			$('#mfdid_'+x).attr('checked',true);
		}
	}
	calculateTotal();
}
function clearhistory(){
}
var url_submit = '<?php echo $this->url(array('module'=>'loan','controller'=>'customerpayment','action'=>'getpaymentbycustomer')); ?>';
function getLaonPayment(type){//តារាងបង់ Tab ទី១
	try{
	tem='';	is_set=0;
		var loan_number = dijit.byId('client_id').get('value');
		dojo.xhrPost({
		    url: url_submit,
		    content : { 
			    'client_id':loan_number,
			    'type':type,
			},	
			handleAs:"json",
			load: function(respone) {
				tem='<table class="collape tablesorter" style="font-size:12px;" id="table" width="100%">'
					+'<thead><tr><th class="tdheader"><?php echo $tr->translate('NUM');?></th>'
					+'<th class="tdheader"></th>'
					+'<th class="tdheader"><?php echo $tr->translate('PROPERTY_CODE');?></th>'
					+'<th class="tdheader"><?php echo $tr->translate('តម្លៃលក់');?></th>'
					+'<th class="tdheader"><?php echo $tr->translate('ប្រាក់បានបង់សរុប');?></th>'
					+'<th class="tdheader"><?php echo $tr->translate('ប្រាក់នៅសល់សរុប');?></th>'
					+'<th class="tdheader">បង់លើក</th>'
					+'<th class="tdheader" colspan="2"><?php echo $tr->translate('PAY_DATE');?></th>'
					+'<th class="tdheader"><?php echo $tr->translate('ប្រាក់ដើមមុនបង់');?></th>'
					+'<th class="tdheader"><?php echo $tr->translate('ប្រាក់ដើម');?></th>'
					+'<th class="tdheader"><?php echo $tr->translate('INTEREST');?></th>'
					+'<th class="tdheader"><?php echo $tr->translate('PENALIZE');?></th>'
					+'<th class="tdheader"><?php echo $tr->translate('SERVICE_CHARGE');?></th>'
					+'<th class="tdheader"><?php echo $tr->translate('AMOUNT_PAYMENT');?></th>'
					+'<th class="tdheader"><?php echo $tr->translate('STATUS');?></th>'
				+'</thead>';
				if(respone!=""){
					num=0;
					total_principal_permonthpaid=0;
					for(i=0;i<respone.length;i++){
						inx = i+1;num++;
						date = new Date(respone[i].date_payment);
						str_day = getDayString(date.getDay());
						client_id = respone[i].client_id;
						begining_balance_after = respone[i].begining_balance_after;
						principal_permonth = respone[i].principal_permonthafter;
						interest = respone[i].total_interest_after;
						total_payment = respone[i].total_payment_after;
						total_payment = parseFloat(total_payment);
						penalty = respone[i].penelize;
						date_pay = respone[i].date_payments;
						id = respone[i].id;
						
						if(respone[i].total_principal_permonthpaid==null){
							respone[i].total_principal_permonthpaid=0;
						}
						total_principal_permonthpaid = total_principal_permonthpaid+parseFloat(respone[i].total_principal_permonthpaid);
						if(i==0){
							clearhistory();
							dijit.byId('buy_with').attr('value',respone[i].buy_with);	
						}
							pay_option = dijit.byId('option_pay').get('value');
							tem+= '<tr id=tr_'+inx+' style="background-color:none">';
							tem += '<td>&nbsp;'+num+'</td>';
							tem += '<td><input type="checkbox" class="checkbox" name="mfdid_'+inx+'" id="mfdid_'+inx+'" value="'+respone[i].record_id+'" OnChange="calculateTotal('+inx+')" checked="checked"/><input type="hidden"  name="total_principal_permonthpaid'+inx+'" id="total_principal_permonthpaid'+inx+'" value="'+respone[i].total_principal_permonthpaid+'" /></td>';
							tem += '<td style="white-space: nowrap;text-align:center;"><input type="hidden" class="checkbox" name="sale_id'+inx+'" id="sale_id'+inx+'" value="'+respone[i].id+'" />&nbsp;<input type="hidden"  name="price_sold'+inx+'" id="price_sold'+inx+'" value="'+respone[i].price_sold+'" /><input type="hidden"  name="land_name'+inx+'" id="land_name'+inx+'" value="'+respone[i].property_address+'" />'+respone[i].property_address+'&nbsp;</td>';

							 tem += '<td style="white-space: nowrap;">&nbsp;'+dojo.number.format(respone[i].price_sold)+'&nbsp;</td>';
							 tem += '<td style="white-space: nowrap;">&nbsp;'+dojo.number.format(respone[i].total_principal_permonthpaid)+'&nbsp;</td>';
							 remain_balance = parseFloat(respone[i].price_sold)-parseFloat(respone[i].total_principal_permonthpaid);
							 tem += '<td style="white-space: nowrap;">&nbsp;'+dojo.number.format(remain_balance)+'&nbsp;<input type="hidden"  name="remain_balance'+inx+'" id="remain_balance'+inx+'" value="'+remain_balance+'" /></td>';
							
							tem += '<td style="white-space: nowrap;text-align:center;">&nbsp;<input dojoType="dijit.form.TextBox" type="hidden"  name="no_installment'+inx+'" id="no_installment'+inx+'" value="'+respone[i].no_installment+'" />'+respone[i].no_installment+'&nbsp;<input type="hidden"  name="house_id'+inx+'" id="house_id'+inx+'" value="'+respone[i].house_id+'" /><input type="hidden"  name="sale_code'+inx+'" id="sale_code'+inx+'" value="'+respone[i].sale_number+'" /></td>';
						    tem += '<td style="white-space: nowrap;text-align:center;">&nbsp;'+date_pay+'&nbsp;<input type="hidden" name="date_payment_'+inx+'" id="date_payment_'+inx+'" value="'+respone[i].date_payment+'" /><input type="hidden" name="last_date_payment_'+inx+'" id="last_date_payment_'+inx+'" value="'+respone[i].paid_date+'" /></td>';
						    tem += '<td style="white-space: nowrap;">&nbsp;'+str_day+'&nbsp;</td>';
						    tem += '<td>&nbsp;'+dojo.number.format(begining_balance_after)+'&nbsp;<input type="hidden" name="total_priciple_'+inx+'" id="total_priciple_'+inx+'" value="'+begining_balance_after+'" /><input type="hidden" name="old_total_priciple_'+inx+'" id="old_total_priciple_'+inx+'" value="'+begining_balance_after+'" /></td>';
						    tem += '<td>&nbsp;'+dojo.number.format(principal_permonth)+'&nbsp;<input type="hidden" name="principal_permonth_'+inx+'" id="principal_permonth_'+inx+'" value="'+principal_permonth+'" /><input type="hidden" name="old_principal_permonth_'+inx+'" id="old_principal_permonth_'+inx+'" value="'+principal_permonth+'" /></td>';
						    tem += '<td>&nbsp;<label id="lb_interest_'+inx+'">'+dojo.number.format(interest)+'</label>&nbsp;&nbsp;<input type="hidden" name="interest_'+inx+'" id="interest_'+inx+'" value="'+interest+'" /><input type="hidden" name="old_interest_'+inx+'" id="old_interest_'+inx+'" value="'+interest+'" /></td>';
						    tem += '<td>&nbsp;<label id="lb_penelize_'+inx+'">'+dojo.number.format(penalty)+'</label>&nbsp;<input type="hidden" name="penelize_'+inx+'" id="penelize_'+inx+'" value="'+penalty+'" /><input type="hidden" name="old_penelize_'+inx+'" id="old_penelize_'+inx+'" value="'+penalty+'" /></td>';
						    tem += '<td>&nbsp;'+dojo.number.format(respone[i].service_charge)+'&nbsp;<input type="hidden" name="service_'+inx+'" id="service_'+inx+'" value="'+respone[i].service_charge+'" /><input type="hidden" name="old_service_'+inx+'" id="old_service_'+inx+'" value="'+respone[i].service_charge+'" /></td>';
						    tem += '<td>&nbsp;<label id="lb_payment_'+inx+'">'+dojo.number.format(total_payment,2)+'</label>&nbsp;<input type="hidden" name="payment_'+inx+'" id="payment_'+inx+'" value="'+total_payment+'" /><input type="hidden" name="old_payment_'+inx+'" id="old_payment_'+inx+'" value="'+total_payment+'" /></td>';
						    tem += '&nbsp;';
							status='<label style="color:red;"><?php echo $tr->translate('NOT_COMPLETED');?></label>';
								if(is_set!=1){
									getdataPaymentToForm(respone[i]);
									if((respone[i].last_pay_date==null)  && (respone[i].installment_date==null) ){
										$('#installment_date').val(respone[i].release_date);
									}else if(respone[i].last_pay_date==null || respone[i].last_pay_date==""){
										$('#installment_date').val(respone[i].installment_date);
									}else{
										$('#installment_date').val(respone[i].last_pay_date);
									}
									is_set=1;
								}
							is_appr='';
							tem += '<td>&nbsp;<label style="font-size:10px;">'+status+'</label></td>';
						    tem += '</tr>';
						    dijit.byId('identity').attr('value',1);
	 					    if(inx!=1) {
	 							var identity = dijit.byId('record_id').get('value');
	 							dijit.byId('record_id').attr('value',identity+','+inx);
	 							var sale_id = dijit.byId('sale_id').get('value');
	 							var property_id = dijit.byId('property_id').get('value');
	 							dijit.byId('sale_id').attr('value',sale_id+','+respone[i].id);
	 							dijit.byId('property_id').attr('value',property_id+','+respone[i].house_id);
	 						} else {
	 							dijit.byId('record_id').attr('value',inx);
	 							dijit.byId('sale_id').attr('value',respone[i].id);
	 							dijit.byId('property_id').attr('value',respone[i].house_id);
	 							dijit.byId('paid_times').attr('value',respone[i].no_installment);
	 						}
					}
				}else{
					var clientId = dijit.byId('client_id').get('value');
					//dijit.byId('loan_number').attr('value','');
					dijit.byId('client_code').attr('value',clientId);
					alert("មិនមានទិន្នន័យទេ!");
					dijit.byId('identity').attr('value',"");
					dijit.byId('priciple_amount').attr('value',0);
					dijit.byId('os_amount').attr('value',0);
					dijit.byId('total_payment').attr('value',0);
					dijit.byId('amount_receive').attr('value',0);
					dijit.byId('service_charge').attr('value',0);
					dijit.byId('penalize_amount').attr('value',0);
					dijit.byId('total_interest').attr('value',"");					
				}
				dijit.byId('total_pricipalpaid').attr('value',total_principal_permonthpaid);	
				tem+='</table>';
				dojo.byId('data_table').innerHTML = tem;				
				calculateTotal();//set data to form
			},
			error: function(e) {
			}
		});
	}catch(err){
	}	
}
function totalAmountpay(){//calculate money must paid
}
function calculateTotal(index){
	try{
		
		var penelize = 0;
		var total_payment = 0;
		var os_amount = 0;
		var total_interest = 0;
		var priciple_amount = 0;
		var total_interest_late = 0;
		var after_discount = 0;
		var totalAmount = 0;
		var payOption = dijit.byId('option_pay').get('value');
		var payment_term = 3;//month
		var interest_rate =0;// dijit.byId('interest_rate').get('value');
		var date_collect = dijit.byId('collect_date').get('value');
		var total_penelize =0;
		var service_charge_amount=0;
		var condition = 0;
		var ids =dijit.byId('record_id').get('value');
  	  	dijit.byId('identity').attr('value',ids);
		
		var arrays = ids.split(',');
	   ids = dijit.byId("identity").get('value');
	   var arrays = ids.split(',');
	   graice_period = '<?php echo $graiceperiod["value"]?>';
	   principalpaid = 0;
		if(arrays!=""){
			is_set = 0;
			for(var i=0;i<arrays.length;i++) {
				last_payment_date=0;
				var oneDay = 24*60*60*1000;
				//if($('#mfdid_'+arrays[i]).attr('checked')){
				if ($('#mfdid_'+arrays[i]).is(':checked')) {
					paid_times = $('#no_installment'+arrays[i]).val();
					dijit.byId('paid_times').attr("value",paid_times);
					
					principalpaid = principalpaid+parseFloat($('#total_principal_permonthpaid'+arrays[i]).val());
		          	var os_amount = os_amount+parseFloat($('#principal_permonth_'+arrays[i]).val());//ប្រាក់ដើមត្រូវបង់ជួរ១ៗ
		          	var priciple_amount = priciple_amount+parseFloat($('#remain_balance'+arrays[i]).val())-parseFloat($('#principal_permonth_'+arrays[i]).val());
		          	var totalPayment = parseFloat($('#payment_'+arrays[i]).val());
		          	var principlePerMonth = $('#principal_permonth_'+arrays[i]).val();
		          	old_interest = $('#old_interest_'+arrays[i]).val();
		          	var interest = parseFloat($('#interest_'+arrays[i]).val());
					penelize =  parseFloat($('#old_penelize_1').val());
					var old_service_charge =  parseFloat($('#old_service_1').val());
		          	var service_charge = parseFloat($('#service_'+arrays[i]).val());
		        	service_charge_amount = service_charge_amount + parseFloat($('#service_'+arrays[i]).val());
		          	last_payment_date= $('#last_date_payment_1').val();
		          	if(last_payment_date=="null" || last_payment_date==null || last_payment_date=="" ){
						pay_date= new Date($('#date_payment_1').val());
					}else{
						date_payment= ($('#date_payment_1').val());
						if(last_payment_date<date_payment){
							pay_date = new Date(date_payment);
						}else{
							pay_date = new Date(last_payment_date);
						}
					}
					var late_day = Math.round((date_collect - pay_date)/(oneDay));
					if(late_day>0){
						if(last_payment_date=="null" || last_payment_date==null || last_payment_date==""){
							if(late_day<=graice_period ){
								total_late_days = 0;
							}else{
								total_late_days = late_day - graice_period;
							}
							total_late_day = total_late_days;
						}else{
							total_late_day = late_day;
						}
					}else{
						total_late_day = late_day;
					}
					totalPay =  parseFloat(principlePerMonth) + parseFloat(interest);
					if(total_late_day>0){ //have late 
						dijit.byId('late_day').attr('value',total_late_day + " Days");
						if(payment_term==3){//for month
								dijit.byId('priciple_amount').attr('value',0);
								total_priciple_amount = $('#total_priciple_1').val();
								interestPermonth1 = $('#interest_1').val(); //  ខែទី ១ គិតការប្រាក់ពេញ
								interestPermonth2 = $('#interest_2').val(); // ខែទី ២  គិតការប្រាក់តាមចំនួនថ្ងៃដែលលើស
								priciple_permonth2 = $('#principal_permonth_2').val();
								totalPayPerMonth = 	parseFloat(priciple_permonth2) + parseFloat(interestPermonth2);								
								interest_day = abs(total_priciple_amount * (interest_rate/12/30/100) * total_late_day);
								interest_day = roundhundred(interest_day);	
								total_interest = parseFloat(interestPermonth1) + parseFloat(interest_day);
								total_penelize = roundhundred((parseFloat(totalPayPerMonth)*parseFloat(total_late_day))+parseFloat(penelize));
								totalAmount = totalAmount + parseFloat(principlePerMonth);
								if(condition==0){
									totalAmount = parseFloat(totalAmount) + parseFloat(total_penelize) + parseFloat(total_interest) + parseFloat(old_service_charge);
									condition=1;
								}
						}
					}else if(total_late_day==0){
						dijit.byId('late_day').attr('value',0 + " Days");
						if(payOption==1){
							total_penelize_peryear =0+parseFloat(penelize);
							total_interest_late = total_interest_late +0;
							total_penelize = parseFloat(total_interest_late)+parseFloat(penelize);
							document.getElementById('lb_penelize_'+arrays[i]).innerHTML = roundhundred(total_penelize_peryear);
							$('#penelize_'+arrays[i]).val(roundhundred(total_penelize_peryear));
							total_payment_permonth = parseFloat(totalPay)+parseFloat(total_penelize_peryear)+service_charge;
							document.getElementById('lb_payment_'+arrays[i]).innerHTML = roundhundred(total_payment_permonth);
							$('#payment_'+arrays[i]).val(roundhundred(total_payment_permonth));
							totalAmount = totalAmount + parseFloat(totalPay)+penelize+service_charge;
							var total_interest = total_interest+parseFloat($('#interest_'+arrays[i]).val());
						}else{
							total_penelize = parseFloat(penelize);
							total_interest = $('#interest_1').val();
							totalAmount = totalAmount + parseFloat(principlePerMonth);
							if(condition==0){
								totalAmount = parseFloat(totalAmount) +  parseFloat(total_interest) + parseFloat(total_penelize) + parseFloat(old_service_charge);
								condition=1;
							}
						}
					}else{//total_late_day<0
						dijit.byId('late_day').attr('value',0 + " Days");
						dijit.byId('option_pay').attr('readOnly',false);
						if(payOption==1){//pay normall
							total_interest_late = total_interest_late + 0;
							var ids =dijit.byId('record_id').get('value');
							  var arraysn = ids.split(',');
							  for(var j=0;j<arraysn.length;j++){
								old_interest = $('#old_interest_'+arraysn[j]).val();
								document.getElementById('lb_interest_'+arraysn[j]).innerHTML = (parseFloat(old_interest));
								$('#interest_'+arraysn[j]).val((parseFloat(old_interest)));
							  }								
							var total_interest = total_interest+parseFloat($('#interest_1').val());
							total_penelize = parseFloat(total_penelize) +  parseFloat(penelize); 	
							totalAmount = parseFloat(principlePerMonth) + parseFloat(interest) + parseFloat(service_charge) + parseFloat(penelize);
							document.getElementById('lb_penelize_'+arrays[i]).innerHTML = (total_penelize);
							$('#penelize_'+arrays[i]).val((total_penelize+parseFloat(penelize)));
							amount_payments = (parseFloat(principlePerMonth) + parseFloat(interest) + parseFloat(service_charge) + parseFloat(penelize));
							amount_payments = amount_payments.toFixed(2);
							document.getElementById('lb_payment_'+arrays[i]).innerHTML = amount_payments;
							total_amount = (parseFloat(totalPay)+parseFloat(total_interest_late)+parseFloat(penelize)+parseFloat(service_charge));
							total_amount = total_amount.toFixed(2);
							$('#payment_'+arrays[i]).val(total_amount);
						}else if(payOption==4){//បង់ផ្តាច់
							total_interest_late = total_interest_late + 0;
							total_interest = 0;
							priciple_amount = 0;
							priciple_permonth=0;
							os_amounts=0;
							total_interests=0;
							total_penelize = 0;
							lastPaidDate = dijit.byId('lastpaiddate').get('value');
							lastdate = new Date(lastPaidDate);
							paidDate = new Date(date_collect);
							amount_using_day = Math.round((paidDate - lastdate )/oneDay);
							total_priciple_amount = $('#total_priciple_1').val();
							  if(amount_using_day>0){
								interest = abs(total_priciple_amount * (interest_rate/12/30/100) * amount_using_day); // interest_rate=12
							  }else{
								interest = 0;  
							  }
							interest = roundhundred(interest);
							var ids =dijit.byId('record_id').get('value');
							var arraysn = ids.split(',');
							  for(var j=0;j<arraysn.length;j++){
									principlePerMonth = $('#principal_permonth_'+arraysn[j]).val();
									os_amounts = parseFloat(os_amounts) + parseFloat(principlePerMonth);
									os_amount_permonth = dijit.byId("sold_price").get("value");
									total_interest_permonth = 0;//this panel
									total_interests = parseFloat(total_interests)+parseFloat(total_interest_permonth);
									if(j==0){//new
									}
								}
							total_penelize = parseFloat(penelize);
							total_interest = (interest);
							totalAmount = parseFloat((os_amounts))+ parseFloat((total_interest))+ parseFloat((penelize))+parseFloat((old_service_charge))+ parseFloat((total_interest_late));
						}
					}
				}
			}
			}else{
				totalAmount=0;
				total_interest_late=0;
				os_amount=0;
				total_interest=0;
				priciple_amount=0;
			}
		dijit.byId('oldTotalPay').attr('value',(totalAmount));
		dijit.byId('amount_receive').attr('value',(os_amount));
		total_penelize=isNaN(total_penelize)?0:total_penelize;
		
		dijit.byId('total_pricipalpaid').attr('value',(principalpaid));
		dijit.byId('penalize_amount').attr('value',(0));
		dijit.byId('old_penelize').attr('value',(total_penelize));
		$('#new_penelize').val((total_interest_late));
		dijit.byId('total_payment').attr('value',(os_amount));//ប្រាក់ត្រូវ​បង់សរុរប
		dijit.byId('os_amount').attr('value',(os_amount));
		dijit.byId('total_interest').attr('value',(total_interest));
		
		dijit.byId('priciple_amount').attr('value',(priciple_amount));//ប្រាក់ដើមនៅសល់បន្ទាប់ពីបង់
		dijit.byId('service_charge').attr('value',(service_charge_amount));

		var identity = dijit.byId('identity').get('value');
		var recored = dijit.byId('record_id').get('value');
		if(identity==recored){
			$('#check_all').attr('checked');
		}
	}catch(err){
		alert(err);
	}
}
function checkAll(index){
}
function getdataPaymentToForm(data){//use
	totalReturn();
}
function getDayString(num){
	var days= ["ច័ន្ទ", "អង្គារ", "ពុធ", "ព្រហ","សុក្រ","សៅរ៏","អាទិត្យ"];
	return days[num];
}
function getCurrencyType(type){
	var option=["៛","$","B"];
	return option[type-1];
}
function adminfee(){
	var admin_fee = dijit.byId().get('value');
	payment = dijit.byId('total_payment').get('value');
}
function doTotalByServ(){
	total_payment_before = dijit.byId('os_amount').get('value');
	service_charge = dijit.byId('service_charge').get('value');
	service_charge=isNaN(service_charge)?0:service_charge;
	penelize = dijit.byId('penalize_amount').get('value');
	extrapayment = dijit.byId('extrapayment').get('value');
	service_charge=isNaN(service_charge)?0:service_charge;
	penelize=isNaN(penelize)?0:penelize;
	extrapayment=isNaN(extrapayment)?0:extrapayment;
	total_pay = parseFloat(total_payment_before)+ parseFloat(service_charge)+parseFloat(extrapayment)+parseFloat(penelize);
	dijit.byId('total_payment').attr('value',total_pay.toFixed(2));
	dijit.byId('amount_receive').attr('value',total_pay.toFixed(2));
}
function totalReturn(){
	service_charge = dijit.byId('service_charge').get('value');
	receive_amount = dijit.byId('amount_receive').get('value');
	total_payment = dijit.byId('oldTotalPay').get('value');
	option_pay = dijit.byId('option_pay').get('value');
	service_charge=isNaN(service_charge)?0:service_charge;
	total_amount = parseFloat(service_charge) + parseFloat(total_payment);
	total_payments = dijit.byId('total_payment').get('value');
	amonut_return = parseFloat(receive_amount)-parseFloat(total_payments);
	remain_amount = parseFloat(total_payments)-parseFloat(receive_amount);
	if(remain_amount>0){
		dijit.byId('remain').attr('value',remain_amount.toFixed(2));
	}else{
		dijit.byId('remain').attr('value',0);
	}
	if(option_pay==1){
		if(receive_amount<total_payments){
			begining_balance = $('#total_priciple_1').val();	
			service_charge = dijit.byId('service_charge').get('value');
			penelize = dijit.byId('penalize_amount').get('value');
			interest = dijit.byId('total_interest').get('value');
			os_amount = receive_amount - service_charge - penelize - interest;
			if(os_amount>0){
				ending_balance = begining_balance - os_amount;
			}else{
				ending_balance = begining_balance;
			}
			dijit.byId('priciple_amount').attr('value',ending_balance);
		}else{
			begining_balance = $('#total_priciple_1').val();
			os_amount = dijit.byId('os_amount').get('value');
			dijit.byId('priciple_amount').attr('value',begining_balance-os_amount);
		}
	}else{
	}
}
function loading(){
     loadingBlock();
}
function roundhundred(n){
	total = parseFloat(n);
	x = total.toFixed(2);
    return x;
}
var url_receiptnumber = "<?php echo $this->url(array('module'=>'loan','controller'=>'ilpayment','action'=>'get-receipt-number')); ?>";
function getReceiptNumber(condition){
	dojo.xhrPost({
		url:url_receiptnumber,	
		content:{ 
		    'branch_id':dijit.byId('branch_id').get('value')
		},		    
		handleAs:"json",
		load: function(data) {
			dijit.byId('reciept_no').attr('value',data);
			if(condition==1){
				showReciept(data);
			}
		},
		error:  function(response, ioArgs) {
			alert("Failed while doing the operation: " + ioArgs.xhr.response);
		}
	});
}
function checkScheduleOption(){
}
</script>
